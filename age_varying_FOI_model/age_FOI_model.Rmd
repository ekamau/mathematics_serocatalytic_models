---
title: "Age varying Force of infection"
output:
  pdf_document: default
  html_document: default
---

<style>
body {
text-align: justify}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The assumption that the force of infection (FOI) is identical across all age groups is not always realistic. The true FOI might differ between age groups due to different mixing and contact patterns and will be higher than the average for children compared to adults for infections like measles and rubella. 
Here we incorporate age-dependent FOI into catalytic models assuming that the FOI is 'piecewise' constant (i.e., constant but different) across age groups.

This document demonstrates how to simulate age seroprevalence data and implement age varying FOI models with and without the assumption of seroreversion.
 
```{r echo=TRUE, eval=FALSE, results='hide'}

# load libraries and setup rstan options:

if (!require("pacman")) install.packages("pacman")
p_load(rstan, tidyverse, reshape2, posterior, bayesplot, patchwork, tidybayes)
rstan_options(auto_write = TRUE)
options(mc.cores = 4)

```

To synthesize age seroprevalence profiles, we define a function, `simulate_foi_age_exact`, which simulates age-specific probabilities of being seropositive. The function takes four arguments as input: a single value of `age`, a vector of FOIs (`fois`), a vector indicating how FOIs vary across the different birth cohorts or age classes (`chunks`) and the seroreversion rate (`mu`).

The function solves piece-wise ODEs for each unit of age:

```{r echo=TRUE, eval=FALSE}

simulate_foi_age_exact <- function(age, fois, chunks, mu) {
  I <- 0
  # solve ODE exactly within pieces:
  for(i in 1:age) {
    lambda <- fois[chunks[i]]
    I <- (1 / (lambda + mu)) * exp(- (lambda + mu)) * (lambda * (exp(lambda + mu)  - 1) + I * (lambda + mu))
  }
  I
}

```


**Example of an infection acquired during early childhood:**

In the first instance, we simulate a seroprevalence profile of an infection acquired during childhood (<= 15 years old), where younger age groups have higher seropositivity compared to older age groups.

```{r echo=TRUE, eval=FALSE}

ages <- seq(1, 40, 1)
sample_size <- 100 # samples per age class
fois <- c(0.3, 0.1, 0.03, 0.007) # vector of FOIs

# define how the four FOIs vary by birth cohorts or age classes: in this case, the FOI is different with each 10-year cohort.
chunks <- unlist(map(seq(1, 4, 1), ~rep(., 10))) 

```

**1) No seroreversion**

The dynamics of seropositive individuals while assuming there is no seroreversion (`mu` is set to 0) are represented as:
$$\frac{\mathrm{d}X(a)}{\mathrm{d}a} = \lambda(a)(1-X(a))$$
where, $$\ X(a=0) = 0$$
and, $$X(a) = 1 - exp(\sum_{i = 1}^{a} \lambda(a))$$


To generate synthetic seroprevalence profiles for all `ages`:

```{r echo=TRUE, eval=FALSE}

mu <- 0.0 # no seroreversion
probability_seropositive <- map_dbl(ages, ~simulate_foi_age_exact(., fois, chunks, mu))
n_seropositive <- vector(length = length(ages))
for(i in seq_along(n_seropositive)) {
  n_seropositive[i] <- rbinom(1, size = sample_size, prob = probability_seropositive[i])
}

df <- data.frame(npos = n_seropositive, total = rep(sample_size, length(n_seropositive)))

ggplot(data = df, aes(x=ages, y=npos)) +
  geom_line() + geom_point() + labs(y = "Number seropositive", x = "Age") +
  ylim(0,100)

```

In R, we specify a list of vectors and inputs to the model:

```{r echo=TRUE, eval=FALSE}

data_stan <- list(
  n_obs = length(n_seropositive), # number of data points or rows in the data
  n_pos = n_seropositive, # number seropositive 
  n_total = rep(sample_size, length(n_seropositive)), # number tested per age unit 
  ages = ages,
  is_binomial = TRUE,
  include_seroreversion = 0, # change here to specify if to include seroreversion
  age_max = max(ages),
  chunks = chunks,
  
  foi_prior_choice = 3, # choice between 1,2,3,4,5 and 6
  foi_prior_a = 0, 
  foi_prior_b = 5,
  serorev_prior_choice = 1, # choice between 1,2 and 3
  serorev_prior_a = 0,
  serorev_prior_b = 1
)

```

In the list above, the `include_seroreversion` variable is a `0|1` switch to indicate if the model should account for seroreversion (`= 1`) or not (`= 0`). There are up to three prior choices for the seroreversion rate parameter and six choices for the FOI parameter. The specification of prior choices and related parameters are described below.

**Using Stan to estimate FOI**

We use the [Stan](https://mc-stan.org/) statistical programming language to write serocatalytic models and [rstan](https://cran.r-project.org/web/packages/rstan/vignettes/rstan.html) R package, the R interface to Stan, to conveniently fit Stan models to the synthetic data in a Bayesian framework and access the posterior inferences.

The Stan program is in a text [file](https://github.com/ekamau/mathematics_serocatalytic_models/blob/main/age_FOI_model-v1.stan).

The function block in Stan specifies functions that compute the probability of being seropositive, similar to the `simulate_foi_age_exact` function above. The data block in the Stan program contains the data list specified in R above.  
The first four FOI prior choices (`foi_prior_choice` <= 4) use normal and Student-t distributions to do a random walk through parameter space. The fifth and sixth FOI prior choices use continuous uniform and cauchy distributions, respectively, over non-negative and finite values (`foi_prior_a` and `foi_prior_b`). 
The uniform distribution can prove troublesome with MCMC, with the samplers taking much longer to converge than weakly informative alternatives. It is recommended that the fifth and six prior choices be used where a large prior range for the parameter value is desired. In most cases, the first four FOI prior choices will most likely suffice.

There are three prior distribution choices for the seroreversion rate parameter: cauchy (`serorev_prior_choice = 1`), normal (`serorev_prior_choice = 2`) and uniform (`serorev_prior_choice = 3`), with user-provided parameters `serorev_prior_a` and `serorev_prior_b`.

To run the models:

```{r echo=TRUE, eval=FALSE, results='hide'}

model <- stan_model("age_FOI_model-v1.stan")

# define initial values:
initfn <- function() { list(log_foi = rep(-8, max(chunks))) }

fit <- sampling(model, data = data_stan, chains = 4, init = initfn, 
                    iter = 3000, warmup = 900, refresh = 0, seed = 345,
                    control = list(adapt_delta = 0.9999, max_treedepth = 25))

```

To check the output and get summary statistics for parameter estimates:

```{r echo=TRUE, eval=FALSE}

s <- as.data.frame(summary(fit, probs = c(0.025, 0.975))$summary)
model_ppc <- tibble::rownames_to_column(s, "parameter") %>% filter(grepl("pos_pred", parameter))

tibble(age=ages, simulated=n_seropositive, model_predicted=model_ppc$mean) %>%
  pivot_longer(-age) %>%
  ggplot(aes(x=age, y=value, colour=name)) +
  geom_line() + geom_point() + labs(y="Number seropositive", colour="") +
  ylim(0,100)

```

Compare the original FOI values used for data simulation with FOI estimates from the model:

```{r, echo=TRUE, eval=FALSE}

tibble::rownames_to_column(s, "parameter") %>% 
  filter(grepl("^foi", parameter)) %>% 
  select(mean) %>% 
  cbind(fois) %>% 
  rename(., all_of(c(model_predicted_FOI = "mean", original_FOI = "fois")))

```


**2) With seroreversion**

The dynamics of seropositivity when assuming possible seroreversion would be:
$$\frac{\mathrm{d}X(a)}{\mathrm{d}a} = \lambda(a)(1-X(a)) - \nu X(a)$$

The same example above but assuming possible seroreversion:

```{r echo=TRUE, eval=FALSE}

mu <- 0.04 # seroreversion
probability_seropositive <- map_dbl(ages, ~simulate_foi_age_exact(., fois, chunks, mu))
n_seropositive <- vector(length = length(ages))
for(i in seq_along(n_seropositive)) {
  n_seropositive[i] <- rbinom(1, size = sample_size, prob = probability_seropositive[i])
}

df <- data.frame(npos = n_seropositive, total = rep(sample_size, length(n_seropositive)))

ggplot(data = df, aes(x=ages, y=npos)) +
  geom_line() + geom_point() + labs(y = "Number seropositive", x = "Age") +
  ylim(0,100)

```

In R, we specify a list of vectors and inputs to the model:

```{r echo=TRUE, eval=FALSE}

data_stan <- list(
  n_obs = length(n_seropositive),
  n_pos = n_seropositive,
  n_total = rep(sample_size, length(n_seropositive)),
  ages = ages,
  is_binomial = TRUE,
  include_seroreversion = 1, 
  age_max = max(ages),
  chunks = chunks,
  
  foi_prior_choice = 3,
  foi_prior_a = 0, 
  foi_prior_b = 5,
  serorev_prior_choice = 1,
  serorev_prior_a = 0,
  serorev_prior_b = 1
)

```

Run the models:

```{r echo=TRUE, eval=FALSE, results='hide'}

fit <- sampling(model, data = data_stan, chains = 4, init = initfn, 
                    iter = 3000, warmup = 900, refresh = 0, seed = 345,
                    control = list(adapt_delta = 0.9999, max_treedepth = 25))

```

Check the output and get summary statistics for parameter estimates:

```{r echo=TRUE, eval=FALSE}

s <- as.data.frame(summary(fit, probs = c(0.025, 0.975))$summary)
model_ppc <- tibble::rownames_to_column(s, "parameter") %>% filter(grepl("pos_pred", parameter))

tibble(age=ages, simulated=n_seropositive, model_predicted=model_ppc$mean) %>%
  pivot_longer(-age) %>%
  ggplot(aes(x=age, y=value, colour=name)) +
  geom_line() + geom_point() + labs(y = "Number seropositive", colour="") +
  ylim(0,100)

```

Compare the original FOI values used for data simulation with FOI estimates from the model:

```{r, echo=TRUE, eval=FALSE}

tibble::rownames_to_column(s, "parameter") %>% 
  filter(grepl("^foi", parameter)) %>% 
  select(mean) %>% 
  cbind(fois) %>% 
  rename(., all_of(c(model_predicted_FOI = "mean", original_FOI = "fois")))

```


**Example of an infection acquired during adulthood**

In the second instance, we simulate an age-specific serological profile with low seroprevalence during childhood.

```{r echo=TRUE, eval=FALSE}

ages <- seq(1, 40, 1)
sample_size <- 100 # samples per age class
fois <- c(0.007, 0.015, 0.15, 0.3) # vector of FOIs

# define how the four FOIs vary by birth cohorts or age classes: in this case, the FOI is different with each 10-year cohort.
chunks <- unlist(map(seq(1, 4, 1), ~rep(., 10))) 

```

**1) No seroreversion**

While assuming there is no seroreversion:

```{r echo=TRUE, eval=FALSE}

mu <- 0.0 # no seroreversion
probability_seropositive <- map_dbl(ages, ~simulate_foi_age_exact(., fois, chunks, mu))
n_seropositive <- vector(length = length(ages))
for(i in seq_along(n_seropositive)) {
  n_seropositive[i] <- rbinom(1, size = sample_size, prob = probability_seropositive[i])
}

df <- data.frame(npos = n_seropositive, total = rep(sample_size, length(n_seropositive)))

ggplot(data = df, aes(x=ages, y=npos)) +
  geom_line() + geom_point() + labs(y = "Number seropositive", x = "Age") +
  ylim(0,100)

```

Data inputs to the model:

```{r echo=TRUE, eval=FALSE}

data_stan <- list(
  n_obs = length(n_seropositive),
  n_pos = n_seropositive,
  n_total = rep(sample_size, length(n_seropositive)),
  ages = ages,
  is_binomial = TRUE,
  include_seroreversion = 0, 
  age_max = max(ages),
  chunks = chunks,
  
  foi_prior_choice = 3,
  foi_prior_a = 0, 
  foi_prior_b = 5,
  serorev_prior_choice = 1,
  serorev_prior_a = 0,
  serorev_prior_b = 1
)

```

Run the models:

```{r echo=TRUE, eval=FALSE, results='hide'}

fit <- sampling(model, data = data_stan, chains = 4, init = initfn, 
                    iter = 3000, warmup = 900, refresh = 0, seed = 345,
                    control = list(adapt_delta = 0.9999, max_treedepth = 25))

```

Check the output and get summary statistics for parameter estimates:

```{r echo=TRUE, eval=FALSE}

s <- as.data.frame(summary(fit, probs = c(0.025, 0.975))$summary)
model_ppc <- tibble::rownames_to_column(s, "parameter") %>% filter(grepl("pos_pred", parameter))

tibble(age=ages, simulated=n_seropositive, model_predicted=model_ppc$mean) %>%
  pivot_longer(-age) %>%
  ggplot(aes(x=age, y=value, colour=name)) +
  geom_line() + geom_point() + labs(y = "Number seropositive", colour="") +
  ylim(0,100)

```


Compare the original FOI values used for data simulation with FOI estimates from the model:

```{r, echo=TRUE, eval=FALSE}

tibble::rownames_to_column(s, "parameter") %>% 
  filter(grepl("^foi", parameter)) %>% 
  select(mean) %>% 
  cbind(fois) %>% 
  rename(., all_of(c(model_predicted_FOI = "mean", original_FOI = "fois")))

```

**2) With seroreversion**

The same example above but assuming possible seroreversion:

```{r echo=TRUE, eval=FALSE}

mu <- 0.04 # seroreversion
probability_seropositive <- map_dbl(ages, ~simulate_foi_age_exact(., fois, chunks, mu))
n_seropositive <- vector(length = length(ages))
for(i in seq_along(n_seropositive)) {
  n_seropositive[i] <- rbinom(1, size = sample_size, prob = probability_seropositive[i])
}

df <- data.frame(npos = n_seropositive, total = rep(sample_size, length(n_seropositive)))

ggplot(data = df, aes(x=ages, y=npos)) +
  geom_line() + geom_point() + labs(y = "Number seropositive", x = "Age") +
  ylim(0,100)

```

Prepare model inputs:

```{r echo=TRUE, eval=FALSE}

data_stan <- list(
  n_obs = length(n_seropositive),
  n_pos = n_seropositive,
  n_total = rep(sample_size, length(n_seropositive)),
  ages = ages,
  is_binomial = TRUE,
  include_seroreversion = 1, 
  age_max = max(ages),
  chunks = chunks,
  
  foi_prior_choice = 3,
  foi_prior_a = 0, 
  foi_prior_b = 5,
  serorev_prior_choice = 1,
  serorev_prior_a = 0,
  serorev_prior_b = 1
)

```

Run the models:

```{r echo=TRUE, eval=FALSE, results='hide'}

fit <- sampling(model, data = data_stan, chains = 4, init = initfn, 
                    iter = 3000, warmup = 900, refresh = 0, seed = 345,
                    control = list(adapt_delta = 0.9999, max_treedepth = 25))

```

Check the output and get summary statistics for parameter estimates:

```{r echo=TRUE, eval=FALSE}

s <- as.data.frame(summary(fit, probs = c(0.025, 0.975))$summary)

model_ppc <- tibble::rownames_to_column(s, "parameter") %>% filter(grepl("pos_pred", parameter))

seroreversion_rate <- tibble::rownames_to_column(s, "parameter") %>% 
  filter(grepl("", parameter))

tibble(age=ages, simulated=n_seropositive, model_predicted=model_ppc$mean) %>%
  pivot_longer(-age) %>%
  ggplot(aes(x=age, y=value, colour=name)) +
  geom_line() + geom_point() + labs(y = "Number seropositive", colour="") + 
  ylim(0,100)

```


Compare the original FOI values used for data simulation with FOI estimates from the model:

```{r, echo=TRUE, eval=FALSE}

tibble::rownames_to_column(s, "parameter") %>% 
  filter(grepl("^foi", parameter)) %>% 
  select(mean) %>% 
  cbind(fois) %>% 
  rename(., all_of(c(model_predicted_FOI = "mean", original_FOI = "fois")))

```